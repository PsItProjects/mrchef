name: iOS - Build & Upload to TestFlight

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:

concurrency:
  group: ios-testflight-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_upload:
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          # Ensure the runner uses a recent Swift toolchain (some Pods require newer Swift keywords).
          xcode-version: latest-stable

      - name: Xcode & Swift versions
        run: |
          set -euo pipefail
          xcodebuild -version
          swiftc --version

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          # Pin Flutter version to avoid CI failures resolving "stable" on macos-14 (arm64)
          flutter-version: "3.29.0"
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Install CocoaPods
        run: |
          set -euo pipefail
          cd ios
          pod install --repo-update

      - name: Validate required secrets
        env:
          APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APPSTORE_KEY_P8: ${{ secrets.APPSTORE_KEY_P8_BASE64 }}
          IOS_DIST_CERT_P12_BASE64: ${{ secrets.IOS_DIST_CERT_P12_BASE64 }}
          IOS_DIST_CERT_PASSWORD: ${{ secrets.IOS_DIST_CERT_PASSWORD }}
          IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
        run: |
          set -euo pipefail
          for v in APPSTORE_KEY_ID APPSTORE_ISSUER_ID APPSTORE_KEY_P8 IOS_DIST_CERT_P12_BASE64 IOS_DIST_CERT_PASSWORD IOS_PROVISION_PROFILE_BASE64; do
            if [[ -z "${!v:-}" ]]; then
              echo "Missing required secret: $v" >&2
              exit 1
            fi
          done

      - name: Install signing certificate & provisioning profile
        env:
          IOS_DIST_CERT_P12_BASE64: ${{ secrets.IOS_DIST_CERT_P12_BASE64 }}
          IOS_DIST_CERT_PASSWORD: ${{ secrets.IOS_DIST_CERT_PASSWORD }}
          IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
        run: |
          set -euo pipefail

          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain-db
          KEYCHAIN_PASSWORD="${KEYCHAIN_PASSWORD:-temp_password}"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "$IOS_DIST_CERT_P12_BASE64" | base64 -D > $RUNNER_TEMP/ios_dist.p12
          ls -l $RUNNER_TEMP/ios_dist.p12

          # Sanity check: ensure the decoded P12 matches the provided password.
          if ! openssl pkcs12 -info -in $RUNNER_TEMP/ios_dist.p12 -noout -passin "pass:$IOS_DIST_CERT_PASSWORD" >/dev/null 2>&1; then
            echo "P12 sanity check failed: password mismatch or corrupted P12" >&2
            exit 1
          fi
          shasum -a 256 $RUNNER_TEMP/ios_dist.p12

          # Some macOS runner images fail to import newer OpenSSL-generated PKCS#12 (PBES2/SHA256)
          # via `security import` even when the password is correct.
          # Workaround: extract cert+key with OpenSSL (already validated above), then import PEMs.
          openssl pkcs12 -in $RUNNER_TEMP/ios_dist.p12 -clcerts -nokeys -passin "pass:$IOS_DIST_CERT_PASSWORD" -out $RUNNER_TEMP/ios_dist_cert.pem
          openssl pkcs12 -in $RUNNER_TEMP/ios_dist.p12 -nocerts -nodes -passin "pass:$IOS_DIST_CERT_PASSWORD" -out $RUNNER_TEMP/ios_dist_key.pem

          if ! security import $RUNNER_TEMP/ios_dist_cert.pem -k "$KEYCHAIN_PATH" -T /usr/bin/codesign -T /usr/bin/security; then
            echo "Failed to import signing certificate into keychain." >&2
            exit 1
          fi
          if ! security import $RUNNER_TEMP/ios_dist_key.pem -k "$KEYCHAIN_PATH" -P "" -T /usr/bin/codesign -T /usr/bin/security; then
            echo "Failed to import signing private key into keychain." >&2
            exit 1
          fi
          rm -f $RUNNER_TEMP/ios_dist_key.pem $RUNNER_TEMP/ios_dist_cert.pem

          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "$IOS_PROVISION_PROFILE_BASE64" | base64 -D > $RUNNER_TEMP/profile.mobileprovision
          UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< "$(security cms -D -i $RUNNER_TEMP/profile.mobileprovision)")
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp $RUNNER_TEMP/profile.mobileprovision "$HOME/Library/MobileDevice/Provisioning Profiles/$UUID.mobileprovision"

      - name: Build IPA (Release)
        run: |
          set -euo pipefail
          VERSION_LINE=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          BUILD_NAME=${VERSION_LINE%%+*}
          if [[ "$VERSION_LINE" == *"+"* ]]; then
            BASE_NUMBER=${VERSION_LINE#*+}
          else
            BASE_NUMBER=0
          fi
          BUILD_NUMBER=$((BASE_NUMBER + GITHUB_RUN_NUMBER))
          echo "Using build-name=$BUILD_NAME build-number=$BUILD_NUMBER"
          flutter build ipa --release --export-method app-store --build-name "$BUILD_NAME" --build-number "$BUILD_NUMBER"

      - name: Resolve IPA path
        id: ipa
        run: |
          set -euo pipefail
          IPA_PATH=$(ls build/ios/ipa/*.ipa | head -n 1)
          echo "ipa_path=$IPA_PATH" >> "$GITHUB_OUTPUT"
          echo "IPA: $IPA_PATH"

      - name: Decode App Store Connect API key (p8)
        id: asc
        env:
          APPSTORE_KEY_P8: ${{ secrets.APPSTORE_KEY_P8_BASE64 }}
        run: |
          set -euo pipefail
          echo "api_private_key<<EOF" >> "$GITHUB_OUTPUT"
          printf '%s\n' "$APPSTORE_KEY_P8" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Upload app to TestFlight
        uses: apple-actions/upload-testflight-build@v3
        with:
          app-path: ${{ steps.ipa.outputs.ipa_path }}
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_KEY_ID }}
          api-private-key: ${{ steps.asc.outputs.api_private_key }}

      - name: Upload build artifact (IPA)
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/ios/ipa/*.ipa
          retention-days: 14
